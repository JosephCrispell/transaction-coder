---
title: "Transaction coding"
author: "Joseph Crispell"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
# Load required packages
library(rmarkdown) # building this report
library(DT) # interactive tables
library(plotly) # interactive graphics

# Set default code chunk options
knitr::opts_chunk$set(echo = FALSE)

# Note data folder
data_folder <- file.path("..", "data")

# Note key parameters
date_column <- "Transaction Date"
date_format <- "%d/%m/%Y"
description_column <- "Transaction Description"
in_column <- "Credit Amount"
out_column <- "Debit Amount"

# Note input files
transactions_file <- file.path(data_folder, "14279266_20221417_0806.csv")
coding_file <- file.path(data_folder, "transaction_coding_dictionary.csv")

# Source functions
source("functions.R")
```

```{r load_data, include=FALSE}

# Load the transactions
transactions <- read.csv(
  transactions_file, 
  stringsAsFactors = FALSE,
  check.names = FALSE
)

# Load transaction coding dictionary
transaction_types <- read.csv(
  coding_file,
  stringsAsFactors = FALSE
)
transaction_coding <- build_transaction_coding_dictionary(transaction_types)
```

# Introduction

The following report summarises monthly bank transactions based upon a key word(s) classification table. Different types of transactions are recognised based upon key words that are found.

The key word classification table  used for the current report is shown here with key word(s) for each type in the `Patterns` column separated by semi colons (`;`):
```{r types_table}
datatable(transaction_types, rownames = FALSE))
```

```{r transactions_dates}
# Convert date column to dates
transactions[, date_column] <- as.Date(
  transactions[, date_column], 
  format = date_format
)

# Get date range
transactions_dates <- range(transactions[, date_column])
```

```{r process_transactions, include=FALSE}
# Extract month from dates
transactions$month <- format(transactions[, date_column], "%m/%Y")

# Convert descriptions to lowercase
transactions[, description_column] <- tolower(transactions[, description_column])

# Classify transactions based on key words
transactions[, c("Type", "Pattern")] <-  
  classify_transactions(
    transactions[, description_column],
    transaction_coding
  )
```

Bank transactions were provided for the from `r format(transactions_dates[1], "%B %Y")` to `r format(transactions_dates[1], "%B %Y")` drawing information from the following columns:

- ``r date_column`` - column containing transaction date
- ``r description_column`` - payment description column
- ``r in_column`` - amount of money paid in
- ``r out_column`` - amount of money paid out

With the following additional columns add based on the type classifications:

- `Type` - transaction type classification
- `Pattern` - pattern that matched for type classification

```{r transactions}
datatable(transactions[, c(date_column, in_column, 
                           out_column, description_column,
                           "Type", "Pattern")],
          rownames = FALSE))
```

# Unclassified transactions

```{r unclassified, include=FALSE}

# Identify unclassified transactions
unclassified <- transactions[transactions$Type == "Unclassified", ]

# Identify standing orders/direct debits?
unique_descriptions <- table(unclassified[, description_column])
unique_descriptions <- unique_descriptions[order(unique_descriptions, decreasing = TRUE)]

# COnvert to dataframe
unique_descriptions <- as.data.frame(unique_descriptions)
colnames(unique_descriptions) <- c("Description", "Number of transactions")
```

Based on the above type classifications using key words, the following transaction descriptions didn't contain any key words:

```{r unclassified_counts}
datatable(unique_descriptions, rownames = FALSE))
```

# Average monthly earnings and costs {.tabset}

```{r monthly_totals, include=FALSE}
# Calculate total pay and costs by month
totals_by_month <- summarise_transactions(
  transactions = transactions,
  in_column = in_column,
  out_column = out_column,
  grouping_columns = "month",
  FUN=sum
)

# Make debit column negative
totals_by_month$`Debit Amount` <- -totals_by_month$`Debit Amount`

# Note average stats
n_rows <- nrow(totals_by_month)
average_in <- totals_by_month[n_rows, in_column]
average_out <- totals_by_month[n_rows, out_column]
average_savings <- totals_by_month[n_rows, "difference"]
```

Without considering transaction type the average monthly earnings, costs, and savings are the following:

- Earnings: `£`r format(round(average_in, 0), big.mark=",")``
- Costs: `£`r format(round(average_out, 0), big.mark=",")``
- Savings: `£`r format(round(average_savings, 0), big.mark=",")``

Here is how the above values vary by month:

## Static

```{r plot_monthly_totals_static}
plot_values_by_month_static(
  totals_by_month[-nrow(totals_by_month), ],
  title = "Total money in and out")
```

## Interactive

```{r plot_monthly_totals_interactive}
plot_values_by_month_interactive(
  totals_by_month[-nrow(totals_by_month), ],
  title = "Total money in and out")
```

## Data

```{r monthly_totals_data}
datatable(totals_by_month[-nrow(totals_by_month), ], rownames = FALSE))
```

# Monthly earnings and costs by type

```{r by_type, include=FALSE}
# Calculate costs by month and type
totals_by_type_and_month <- summarise_transactions(
  transactions = transactions,
  in_column = in_column,
  out_column = out_column,
  grouping_columns = c("month", "Type"),
  FUN=sum,
  calculate_average = FALSE
)

# Calculate average in/out on each type
totals_by_type_and_month[is.na(totals_by_type_and_month)] <- 0
average_by_type <- summarise_transactions(
  transactions = totals_by_type_and_month,
  in_column = in_column,
  out_column = out_column,
  grouping_columns = "Type",
  FUN=mean,
  calculate_average = FALSE
)
average_by_type <- average_by_type[order(average_by_type$difference), ]
```

## {.tabset}

Considering the transaction type we can break down the monthly earnings, costs, and savings on average across the months considered:

### Static

```{r type_average_static}
# Get and set plotting margins
current_mar <- par()$mar
par(mar=c(5.1, 8, 4.1, 2.1))

# Plot the values
barplot(
  height = average_by_type$difference,
  names = average_by_type$Type,
  horiz = TRUE, las = 1, xlab = "£",
  main = "Average value by type",
  cex.names = 0.5
)

# Reset plotting margins
par(mar=current_mar)
```

### Interactive

### Data
```{r type_average_data}
datatable(average_by_type, rownames = FALSE)
```

## {.tabset}
And by month:

```{r pivot_wider}
# Get each types difference by month as column
# Taken from: https://stackoverflow.com/questions/67778341/are-there-alternative-r-base-functions-to-pivot-wider
totals_by_type_and_month$Type <- as.factor(totals_by_type_and_month$Type)
type_difference_by_month <- as.data.frame.matrix(
  xtabs(difference ~ month + Type, totals_by_type_and_month)
)
type_difference_by_month$month <- row.names(type_difference_by_month)
```

### Static
```{r type_by_month_static}
# Plot each type by month
plot_values_by_month_static(
  type_difference_by_month,
  title = "Money in/out by type",
  legend_cex = 0.45)
```

### Interactive
```{r type_by_month_interactive}
# Plot each type by month
plot_values_by_month_interactive(
  type_difference_by_month,
  title = "Money in/out by type"
)
```

### Data
```{r type_by_month_data}
# Plot each type by month
datatable(
  type_difference_by_month,
  extensions = 'FixedColumns',
  options = list(
    dom = 't',
    scrollX = TRUE,
    fixedColumns = list(leftColumns = 1)
  )
)
```

<!-- TO DO:
- Add data behind charts as tab
- Add interactive version of each chart as tab
- Download more months from bank of scotland
-->